<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D.O.G.G. v2.9 - Dashboard ODL Sistema TICKET POTENZIATO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --dark: #2c3e50;
            --gold: #FFD700;
        }
        
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh; color: #fff; margin: 0; padding: 0;
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        
        /* Pannelli e card uniformi */
        .panel {
            background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2); margin-bottom: 30px;
        }
        
        .odl-manager { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        
        /* Bottoni unificati */
        .btn {
            color: white; border: none; padding: 10px 20px; border-radius: 8px;
            cursor: pointer; font-weight: bold; transition: all 0.3s ease;
            margin-left: 10px; display: inline-block;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-success { background: var(--success); }
        .btn-info { background: var(--info); }
        .btn-warning { background: var(--warning); }
        .btn-danger { background: var(--danger); }
        .btn-primary { background: #9b59b6; }
        
        /* Form elements */
        .form-control {
            width: 100%; padding: 10px; border: none; border-radius: 5px;
            background: rgba(255,255,255,0.07); color: white; margin-bottom: 10px;
        }
        
        select.form-control option { background: var(--dark); color: white; }
        
        /* Upload area */
        .upload-area {
            background: rgba(255,255,255,0.1); border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 15px; padding: 40px; text-align: center; cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); }
        
        /* Grid layouts */
        .grid { display: grid; gap: 20px; }
        .grid-auto { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .grid-fill { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; }
        
        /* Cards */
        .card {
            background: rgba(255,255,255,0.1); padding: 25px; border-radius: 15px;
            text-align: center; transition: transform 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        .card:hover { transform: translateY(-5px); }
        .card h3 { font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px; }
        .card-value { font-size: 2rem; font-weight: bold; color: var(--gold); text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        
        /* Progress indicators (ex gauges) */
        .progress-card {
            background: linear-gradient(145deg, var(--dark), #34495e); border-radius: 20px;
            padding: 20px; cursor: pointer; transition: all 0.3s ease; text-align: center;
            position: relative; overflow: hidden;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.3), -5px -5px 15px rgba(255,255,255,0.1);
        }
        .progress-card:hover { transform: translateY(-8px); box-shadow: 0 12px 30px rgba(0,0,0,0.4); }
        
        /* Dog paw animation */
        @keyframes pawPrint { 
            0% { opacity: 0; transform: scale(0) rotate(-15deg); }
            50% { opacity: 1; transform: scale(1.2) rotate(5deg); }
            100% { opacity: 0; transform: scale(1) rotate(0deg); }
        }
        
        /* Badges */
        .badge {
            position: absolute; top: 10px; right: 10px; padding: 4px 8px;
            border-radius: 12px; font-size: 10px; font-weight: bold;
        }
        .badge-manodopera { background: var(--info); }
        .badge-materiali { background: var(--danger); }
        .badge-noleggi { background: var(--warning); }
        .badge-servizi { background: #9b59b6; }
        
        /* Modal system */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.88); z-index: 1000;
        }
        .modal-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--dark); border-radius: 20px; padding: 30px; width: 95%;
            max-width: 800px; max-height: 90vh; color: white; overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { background: none; border: none; font-size: 24px; color: white; cursor: pointer; }
        
        /* Tables */
        table { width: 100%; border-spacing: 0; margin-bottom: 12px; }
        th, td { padding: 4px 6px; font-size: 13px; }
        th { background: #263042; }
        tr:nth-child(even) { background: rgba(255,255,255,0.03); }
        
        /* Alerts */
        .alert {
            padding: 12px; border-radius: 8px; margin: 10px 0; font-weight: bold;
            border-left: 4px solid;
        }
        .alert-success { background: var(--success); border-left-color: #229954; }
        .alert-danger { background: var(--danger); border-left-color: #c0392b; }
        .alert-warning { background: var(--warning); border-left-color: #e67e22; }
        .alert-info { background: var(--info); border-left-color: #2980b9; }
        
        /* Mapping items */
        .mapping-item {
            display: flex; align-items: center; justify-content: space-between;
            margin: 8px 0; padding: 12px; background: rgba(255,255,255,0.03);
            border-radius: 8px; border-left: 4px solid transparent; transition: all 0.3s ease;
        }
        .mapping-item.included { border-left-color: var(--success); background: rgba(39, 174, 96, 0.1); }
        .mapping-item.excluded { border-left-color: var(--danger); background: rgba(231, 76, 60, 0.1); opacity: 0.7; }
        .mapping-item.misura { border-left-color: var(--warning); background: rgba(243, 156, 18, 0.1); }
        
        /* Animations */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes slideOut { from { transform: translateX(0); } to { transform: translateX(100%); } }
        
        /* Utility classes */
        .text-center { text-align: center; }
        .mt-1 { margin-top: 10px; }
        .mt-2 { margin-top: 20px; }
        .mb-1 { margin-bottom: 10px; }
        .mb-2 { margin-bottom: 20px; }
        .hidden { display: none; }
        
        /* Modal system */
        .modal {
            display: none; position: fixed; z-index: 10000; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.8);
        }
        .modal-content {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; margin: 2% auto; padding: 30px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-width: 900px;
            max-height: 90vh; overflow-y: auto; position: relative;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .close { font-size: 28px; font-weight: bold; cursor: pointer; opacity: 0.8; }
        .close:hover { opacity: 1; }
        
        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.2); }
        th { background: rgba(255,255,255,0.1); font-weight: bold; }
        
        /* Badges */
        .badge {
            display: inline-block; padding: 5px 10px; border-radius: 20px;
            font-size: 0.8em; font-weight: bold; margin: 2px;
        }
        .badge-manodopera { background: #3498db; }
        .badge-noleggi { background: #f39c12; }
        .badge-materiali { background: #e74c3c; }
        .badge-servizi { background: #9b59b6; }
        
        /* Progress cards */
        .progress-info { position: relative; margin: 15px 0; }
        .progress-text { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 1.2em; font-weight: bold; z-index: 2;
        }
        .progress-bar {
            width: 80px; height: 80px; border-radius: 50%; margin: 0 auto;
            position: relative; background: rgba(255,255,255,0.1);
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card-footer { margin-top: 10px; opacity: 0.8; }
        
        /* Alerts */
        .alert { 
            padding: 15px; border-radius: 10px; margin: 15px 0; 
            border: 1px solid transparent;
        }
        .alert-success { background: rgba(39, 174, 96, 0.2); border-color: #27ae60; }
        .alert-info { background: rgba(52, 152, 219, 0.2); border-color: #3498db; }
        .alert-warning { background: rgba(243, 156, 18, 0.2); border-color: #f39c12; }
        .alert-danger { background: rgba(231, 76, 60, 0.2); border-color: #e74c3c; }
        
        /* Small buttons */
        .btn-small { padding: 5px 10px; font-size: 0.8em; }
        
        /* Responsive */
        @media (max-width: 600px) {
            .modal-content { padding: 10px; margin: 5% auto; }
            .container { padding: 7px; }
            .odl-manager { flex-direction: column; align-items: stretch; }
            .grid-auto, .grid-fill { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div style="max-width: 150px; margin: 0 auto 20px; opacity: 0.9;">
            <img src="data:image/png;base64,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" 
                 style="width: 100%; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.3); background: white;" 
                 alt="D.O.G.G. - Il tuo fedele assistente">
        </div>
        <h1>🐕 D.O.G.G. v2.9</h1>
        <p>Il tuo fedele assistente per la gestione ODL - Sistema TICKET per fatturazione</p>
        <p style="font-size: 0.9rem; opacity: 0.8;">Dashboard Avanzata • Import Intelligente • Formato TICKET Excel</p>
    </div>

    <!-- ODL Management Panel -->
    <div class="panel odl-manager">
        <label style="font-weight: bold;">📋 Progetto ODL:</label>
        <select class="form-control" id="odlSelector" style="min-width: 200px; margin: 0;">
            <option value="">Seleziona un ODL esistente</option>
        </select>
        <button class="btn btn-success" onclick="app.createNewODL()">🆕 Nuovo ODL</button>
        <button class="btn btn-info hidden" id="btnImportRapportino" onclick="app.openImportRapportino()">🧠 Import Intelligente v2.9</button>
        <button class="btn btn-success hidden" id="btnSaveOdl" onclick="app.salvaODLManuale()">💾 Salva ODL</button>
        <button class="btn btn-info hidden" id="btnBackup" onclick="app.openBackupModal()">📁 Backup</button>
        <button class="btn btn-primary hidden" id="btnExportMensile" onclick="app.openExportMensileModal()">🎫 Export TICKET v2.9</button>
        <button class="btn btn-warning hidden" id="btnLavoriMisura" onclick="app.openLavoriMisuraModal()">🟠 Lavori a Misura</button>
        <button class="btn btn-danger hidden" id="btnResetData" onclick="app.resetCurrentODL()">🗑️ Reset Dati</button>
        <div style="flex-grow: 1; text-align: right;" id="currentOdlInfo">Nessun ODL caricato</div>
    </div>

    <!-- Upload Area -->
    <div class="upload-area" id="uploadArea">
        <div>📁 Trascina qui il file Excel ODL</div>
        <div style="opacity: 0.8;">Supporta file .xlsx del formato ODL</div>
        <input type="file" id="fileInput" accept=".xlsx,.csv" style="display: none;">
    </div>

    <!-- Dashboard -->
    <div class="grid grid-auto hidden" id="totalsPanel">
        <div class="card"><h3>TOTALE ITEM</h3><div class="card-value" id="totalItems">0</div></div>
        <div class="card"><h3>CONSUMATO</h3><div class="card-value" id="totalConsumed">€ 0</div></div>
        <div class="card"><h3>RIMANENTE</h3><div class="card-value" id="totalRemaining">€ 0</div></div>
        <div class="card"><h3>ITEM COMPLETI</h3><div class="card-value" id="completedItems">0</div></div>
    </div>

    <div class="hidden" id="filtersPanel" style="display: flex; gap: 15px; margin-bottom: 30px;">
        <button class="btn btn-info active" data-filter="all">Tutti</button>
        <button class="btn btn-info" data-filter="manodopera">Manodopera</button>
        <button class="btn btn-info" data-filter="materiali">Materiali</button>
        <button class="btn btn-info" data-filter="noleggi">Noleggi</button>
        <button class="btn btn-info" data-filter="servizi">Servizi</button>
    </div>
    
    <div class="grid grid-fill" id="gaugesContainer"></div>
</div>

<!-- Dog Footer -->
<div style="text-align: center; margin-top: 40px; opacity: 0.6;">
    <div style="font-size: 2rem;">🐾</div>
    <p style="font-size: 0.8rem;">D.O.G.G. v2.9 - Il tuo fedele compagno di contabilità industriale</p>
    <p style="font-size: 0.7rem; margin-top: 5px;">Estrazione automatica intelligente per TICKET perfetti!</p>
    <p style="font-size: 0.7rem; margin-top: 5px;">Come il nostro amico nella foto, sempre vigile sui tuoi costi!</p>
</div>

<!-- Modals Container -->
<div id="modalsContainer"></div>

<script>
// ===================================
// 🐕 D.O.G.G. v2.9 - Your Faithful ODL Companion POTENZIATO
// ===================================

const app = {
    // Stato globale
    state: {
        itemsData: [],
        currentFilter: 'all',
        currentOdlId: null,
        currentImportMode: 'nico',
        rapportinoData: null,
        mappingRules: null,
        exportMensileData: null
    },
    
    // Configurazione potenziata v2.9
    config: {
        appName: 'D.O.G.G.',
        version: '2.9',
        appMotto: 'Il tuo fedele assistente per TICKET perfetti',
        categories: {
            manodopera: { patterns: [/P12002630[0-8]|P120026314/], color: '#3498db', emoji: '👨‍💼' },
            noleggi: { patterns: [/P120028254|P120028686|P120028688|P120029262/], color: '#f39c12', emoji: '🚜' },
            materiali: { patterns: [/P120027834|P120029110|P120029288|P120029293/], color: '#e74c3c', emoji: '🧱' },
            servizi: { patterns: [], color: '#9b59b6', emoji: '🔧' }
        },
        // NUOVO v2.9: Parole chiave per riconoscimento automatico
        parolachiaveAttivita: [
            'apertura', 'chiusura', 'bonifica', 'saldatura', 'taglio', 'montaggio', 'smontaggio',
            'rimozione', 'installazione', 'messa in sicurezza', 'pulizia', 'verniciatura',
            'controllo', 'verifica', 'ispezione', 'manutenzione', 'riparazione', 'sostituzione'
        ]
    },
    
    // Inizializzazione
    init() {
        this.setupEventListeners();
        this.loadODLsList();
        this.loadFromStorage();
        this.initModals();
        console.log('🐕 D.O.G.G. v2.9 - TICKET POTENZIATO pronto!');
        console.log('🧠 Nuove funzionalità: Estrazione automatica operatori e attività');
        console.log('🎫 TICKET completo con tutte le colonne ODL');
        console.log('🔧 Debug mode attivo - verifica console per dettagli');
        
        // Test iniziale
        console.log('📊 Configurazione categorie:', this.config.categories);
        console.log('🗄️ Stato iniziale:', this.state);
    },
    
    // Event Listeners unificati
    setupEventListeners() {
        const $ = (id) => document.getElementById(id);
        
        // Upload area
        this.setupDragDrop($('uploadArea'), (file) => this.processFile(file));
        $('uploadArea').onclick = () => $('fileInput').click();
        $('fileInput').onchange = (e) => e.target.files[0] && this.processFile(e.target.files[0]);
        
        // ODL selector
        $('odlSelector').onchange = (e) => e.target.value ? this.loadODL(e.target.value) : this.resetView();
        
        // Filters
        document.querySelectorAll('[data-filter]').forEach(btn => {
            btn.onclick = () => this.setFilter(btn.dataset.filter);
        });
        
        // Modal clicks
        window.onclick = (e) => {
            if (e.target.classList.contains('modal')) e.target.style.display = 'none';
        };
    },
    
    // Drag & Drop helper
    setupDragDrop(element, callback) {
        ['dragover', 'dragleave', 'drop'].forEach(event => {
            element.addEventListener(event, (e) => {
                e.preventDefault();
                if (event === 'drop' && e.dataTransfer.files.length) {
                    callback(e.dataTransfer.files[0]);
                }
            });
        });
    },
    
    // Gestione ODL
    createNewODL() {
        this.showModal('newOdl', `
            <h2>🆕 Crea Nuovo ODL</h2>
            <form onsubmit="app.saveNewODL(event)">
                <input class="form-control" id="newOdlName" required placeholder="Nome Progetto ODL">
                <input class="form-control" id="newOdlDesc" placeholder="Descrizione (opzionale)">
                <button type="submit" class="btn btn-success" style="width: 100%;">✅ Crea ODL</button>
            </form>
        `);
    },
    
    saveNewODL(e) {
        e.preventDefault();
        const name = document.getElementById('newOdlName').value;
        const desc = document.getElementById('newOdlDesc').value;
        const odlId = `ODL_${Date.now()}`;
        
        const odls = this.getStorageJson('odlsList');
        odls[odlId] = { name, description: desc, date: new Date().toLocaleDateString('it-IT'), created: Date.now() };
        localStorage.setItem('odlsList', JSON.stringify(odls));
        
        this.state.currentOdlId = odlId;
        this.state.itemsData = [];
        this.updateView();
        this.loadODLsList();
        document.getElementById('odlSelector').value = odlId;
        this.hideModal();
        this.toast(`✅ Nuovo ODL "${name}" creato!`);
    },
    
    loadODL(odlId) {
        const data = this.getStorageJson(`odlData_${odlId}`);
        
        // ✅ FIX: Gestisci correttamente i dati caricati
        if (Array.isArray(data)) {
            this.state.itemsData = data;
        } else if (data && typeof data === 'object' && data.length !== undefined) {
            // Potrebbe essere un oggetto array-like
            this.state.itemsData = Object.values(data);
        } else {
            // Nessun dato trovato
            this.state.itemsData = [];
        }
        
        this.state.currentOdlId = odlId;
        this.updateView();
        
        console.log(`📂 ODL ${odlId} caricato: ${this.state.itemsData.length} item`);
    },
    
    loadODLsList() {
        const odls = this.getStorageJson('odlsList');
        const selector = document.getElementById('odlSelector');
        selector.innerHTML = '<option value="">Seleziona un ODL esistente</option>';
        
        Object.entries(odls).forEach(([id, odl]) => {
            selector.innerHTML += `<option value="${id}">${odl.name} (${odl.date})</option>`;
        });
    },
    
    processFile(file) {
        if (!this.state.currentOdlId) {
            alert('⚠️ Prima crea un nuovo ODL o selezionane uno esistente!');
            return;
        }
        
        if (!file.name.match(/\.(xlsx|csv)$/i)) {
            alert('Seleziona un file Excel (.xlsx) o CSV');
            return;
        }
        
        console.log('🔄 Processando file:', file.name);
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                console.log('📊 Workbook caricato, fogli:', workbook.SheetNames);
                
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, {header: 1});
                console.log('📋 Dati estratti dal foglio:', jsonData.length, 'righe');
                
                const oldItemsCount = this.state.itemsData.length;
                this.state.itemsData = this.extractItemsFromODL(jsonData);
                console.log('🔄 Items prima:', oldItemsCount, 'dopo:', this.state.itemsData.length);
                
                this.saveToStorage();
                this.updateView();
                this.toast(`✅ ODL caricato: ${this.state.itemsData.length} item trovati`);
            } catch (error) {
                console.error('❌ Errore processamento file:', error);
                alert('Errore lettura file: ' + error.message);
            }
        };
        reader.readAsArrayBuffer(file);
    },
    
    extractItemsFromODL(rows) {
        const items = [];
        let reading = false;
        
        console.log('🔍 Analisi righe ODL:', rows.length);
        
        rows.forEach((row, idx) => {
            // Debug: mostra le prime righe per capire la struttura
            if (idx < 15) {
                console.log(`Riga ${idx}:`, row);
            }
            
            // ✅ FIX SPECIFICO: Riconoscimento header riga 6
            if (idx === 6 && row[1] && row[1].toString().toLowerCase().includes('capitolo')) {
                reading = true;
                console.log('✅ Inizio lettura item ODL alla riga', idx, '- Header trovato:', row[1]);
                return; // Salta l'header
            }
            
            // ✅ FIX SPECIFICO: Estrazione item dalla struttura corretta
            if (reading && row.length >= 8) {
                // Struttura fissa: [vuoto, capitolo, codice, descrizione, um, quantita, prezzo_unit, prezzo_tot, note]
                const capitolo = row[1];
                
                // ✅ RICERCA CODICE NELLE PRIME 3 COLONNE
                let codice = null;
                let codeIndex = -1;
                
                // Cerca il codice P120 nelle colonne 0, 1, 2
                for (let i = 0; i <= 2; i++) {
                    if (row[i] && row[i].toString().startsWith('P120')) {
                        codice = row[i].toString();
                        codeIndex = i;
                        break;
                    }
                }
                
                // DEBUG: Log dettagliato per ogni riga durante la lettura
                console.log(`🔍 Riga ${idx} - Capitolo: "${capitolo}" - Codice: "${codice}" (trovato in col ${codeIndex})`);
                
                // Verifica che sia una riga di item valida
                if (codice && codice.startsWith('P120') && !isNaN(capitolo) && capitolo > 0) {
                    // Adatta gli indici in base a dove abbiamo trovato il codice
                    const descrizione = row[codeIndex + 1] || '';
                    const unitaMisura = row[codeIndex + 2] || 'n.';
                    const quantita = parseFloat(row[codeIndex + 3]) || 0;
                    const prezzoUnitario = parseFloat(row[codeIndex + 4]) || 0;
                    let prezzoTotale = parseFloat(row[codeIndex + 5]) || 0;
                    const note = row[codeIndex + 6] || '';
                    
                    // Se prezzoTotale è 0, calcolalo
                    if (prezzoTotale === 0 && quantita > 0 && prezzoUnitario > 0) {
                        prezzoTotale = quantita * prezzoUnitario;
                    }
                    
                    const categoria = this.determineCategory(codice, descrizione);
                    
                    const item = {
                        id: items.length,
                        codiceMateriale: codice,
                        descrizione: descrizione || 'Descrizione non disponibile',
                        unitaMisura: unitaMisura || 'n.',
                        quantita: quantita,
                        prezzoUnitario: prezzoUnitario,
                        prezzoTotale: prezzoTotale,
                        note: note,
                        categoria,
                        produzione: [],
                        completamento: 0,
                        consumato: 0
                    };
                    
                    items.push(item);
                    console.log(`📊 Item ${items.length}: ${codice} - ${categoria} - ${descrizione.substring(0, 30)}... - Qty:${quantita} €${prezzoTotale}`);
                }
                // ✅ FIX SPECIFICO: Riconoscimento fine lista (quando non troviamo più codici P120)
                else if (!codice || !codice.startsWith('P120')) {
                    reading = false;
                    console.log('⛔ Fine lettura item ODL alla riga', idx, '- Nessun codice P120 trovato');
                }
            }
        });
        
        console.log(`✅ Totale item estratti: ${items.length}`);
        
        if (items.length === 0) {
            console.warn('⚠️ NESSUN ITEM TROVATO! Debug delle prime 20 righe:');
            rows.slice(0, 20).forEach((row, idx) => {
                console.log(`DEBUG Riga ${idx}:`, row);
            });
        }
        
        return items;
    },
    
    determineCategory(codice, descrizione) {
        for (const [cat, info] of Object.entries(this.config.categories)) {
            if (info.patterns.some(p => p.test(codice))) return cat;
        }
        return 'servizi';
    },
    
    // 🧠 SISTEMA IMPORT INTELLIGENTE v2.9
    openImportRapportino() {
        this.showModal('import', this.getImportModalContent());
    },
    
    getImportModalContent() {
        return `
            <h2>🧠 Import Rapportino Intelligente v2.9</h2>
            <div class="alert alert-info">
                <strong>🎯 SISTEMA AUTOMATICO POTENZIATO</strong><br>
                • <strong>ESTRAZIONE OPERATORI:</strong> Trova automaticamente tutti i nomi<br>
                • <strong>DESCRIZIONI ATTIVITÀ:</strong> Riconosce automaticamente le attività<br>
                • <strong>COLONNE MULTIPLE:</strong> Separa automaticamente operatori per lo stesso ITEM<br>
                • <strong>TICKET COMPLETO:</strong> Include TUTTI gli item ODL anche senza produzione
            </div>
            <div class="upload-area" onclick="document.getElementById('rapportinoFileInput').click()">
                <div>📁 Seleziona rapportino Excel/CSV</div>
                <div style="opacity: 0.8;">🧠 Estrazione automatica operatori e attività</div>
                <input type="file" id="rapportinoFileInput" accept=".xlsx,.xls,.csv" style="display: none;" 
                       onchange="app.processRapportinoSmart(this.files[0])">
            </div>
            <div id="importResults"></div>
        `;
    },
    
    // 🧠 PROCESSORE RAPPORTINO INTELLIGENTE v2.9
    processRapportinoSmart(file) {
        if (!file?.name.match(/\.(xlsx|xls|csv)$/i)) {
            alert('⚠️ Seleziona un file Excel o CSV');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // ESTRAZIONE AUTOMATICA COMPLETA
                const risultati = this.estrazioneAutomaticaCompleta(sheet);
                this.mostraRisultatiEstrazione(risultati);
                
            } catch (error) {
                alert('❌ Errore: ' + error.message);
            }
        };
        reader.readAsArrayBuffer(file);
    },
    
    // 🧠 ESTRAZIONE AUTOMATICA COMPLETA
    estrazioneAutomaticaCompleta(sheet) {
        const risultati = {
            dataLavoro: null,
            operatori: new Set(),
            attivita: new Map(),
            produzioni: [],
            statistiche: {
                celleAnalizzate: 0,
                operatoriTrovati: 0,
                attivitaTrovate: 0,
                produzioniCreate: 0
            }
        };
        
        // Estrai data dal rapportino
        risultati.dataLavoro = this.estraiDataRapportino(sheet);
        
        // Scansiona TUTTO il foglio per trovare operatori e attività
        const range = XLSX.utils.decode_range(sheet['!ref']);
        
        for (let row = range.s.r; row <= range.e.r; row++) {
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cellRef = XLSX.utils.encode_cell({r: row, c: col});
                const cellValue = this.getCellValue(sheet, cellRef);
                
                if (cellValue && typeof cellValue === 'string') {
                    risultati.statistiche.celleAnalizzate++;
                    
                    // RICONOSCIMENTO AUTOMATICO OPERATORI
                    if (this.sembraNomeOperatore(cellValue)) {
                        risultati.operatori.add(cellValue.trim());
                        risultati.statistiche.operatoriTrovati++;
                    }
                    
                    // RICONOSCIMENTO AUTOMATICO ATTIVITÀ
                    if (this.sembraDescrizioneAttivita(cellValue)) {
                        const attivitaPulita = this.pulisciDescrizioneAttivita(cellValue);
                        const dataKey = `${row}_${col}`;
                        risultati.attivita.set(dataKey, attivitaPulita);
                        risultati.statistiche.attivitaTrovate++;
                    }
                }
            }
        }
        
        // ESTRAZIONE AUTOMATICA PRODUZIONI
        risultati.produzioni = this.estraiProduzioniAutomatiche(sheet, risultati);
        risultati.statistiche.produzioniCreate = risultati.produzioni.length;
        
        return risultati;
    },
    
    // 🧠 RICONOSCIMENTO NOMI OPERATORI
    sembraNomeOperatore(testo) {
        const testoTrim = testo.trim();
        
        // Regole per riconoscere nomi operatori
        if (testoTrim.length < 3 || testoTrim.length > 25) return false;
        if (!/^[A-Z][a-zA-Z\s']+$/.test(testoTrim)) return false;
        if (/\d/.test(testoTrim)) return false;
        if (testoTrim.includes('€') || testoTrim.includes('%')) return false;
        
        // Esclude parole tecniche comuni
        const paroleTecniche = [
            'TOTALE', 'PARZIALE', 'SUBTOTALE', 'IMPORTO', 'PREZZO', 'QUANTITA',
            'DESCRIZIONE', 'CODICE', 'UNITA', 'MISURA', 'MATERIALE', 'LAVORO',
            'OPERAZIONI', 'ATTIVITA', 'SERVIZIO', 'FORNITURA', 'NOLEGGIO'
        ];
        
        if (paroleTecniche.some(p => testoTrim.toUpperCase().includes(p))) return false;
        
        // Deve contenere almeno una sillaba tipica di nomi italiani
        const sillabe = ['bucch', 'bord', 'ross', 'bian', 'verd', 'mari', 'giov', 'fran', 'carl', 'ant'];
        if (sillabe.some(s => testoTrim.toLowerCase().includes(s))) return true;
        
        // Nomi con almeno 2 parti (nome cognome)
        const parti = testoTrim.split(/\s+/);
        return parti.length >= 2 && parti.every(p => p.match(/^[A-Z][a-z]+$/));
    },
    
    // 🧠 RICONOSCIMENTO DESCRIZIONI ATTIVITÀ
    sembraDescrizioneAttivita(testo) {
        const testoLower = testo.toLowerCase();
        
        // Deve contenere almeno una parola chiave di attività
        return this.config.parolachiaveAttivita.some(parola => testoLower.includes(parola));
    },
    
    // 🧠 PULISCI DESCRIZIONE ATTIVITÀ
    pulisciDescrizioneAttivita(testo) {
        return testo.trim()
            .replace(/^[0-9\.\-\s]+/, '') // Rimuovi numerazione iniziale
            .replace(/\s+/g, ' ') // Normalizza spazi
            .replace(/[^\w\s\-àèéìòù]/gi, '') // Rimuovi caratteri speciali
            .substring(0, 50); // Limita lunghezza
    },
    
    // 🧠 ESTRAI DATA RAPPORTINO
    estraiDataRapportino(sheet) {
        // Cerca nelle prime 15 righe
        for (let row = 0; row < 15; row++) {
            for (let col = 0; col < 10; col++) {
                const cellRef = XLSX.utils.encode_cell({r: row, c: col});
                const cellValue = this.getCellValue(sheet, cellRef);
                
                if (cellValue && typeof cellValue === 'string') {
                    if (cellValue.includes('Rapporto di Lavoro del')) {
                        // Cerca la data nella cella successiva
                        const nextCellRef = XLSX.utils.encode_cell({r: row, c: col + 2});
                        const dataValue = this.getCellValue(sheet, nextCellRef);
                        const dataParsed = this.parseDate(dataValue);
                        if (dataParsed) return dataParsed;
                    }
                }
            }
        }
        
        // Fallback: data di oggi
        return new Date().toISOString().split('T')[0];
    },
    
    // 🧠 ESTRAI PRODUZIONI AUTOMATICHE
    estraiProduzioniAutomatiche(sheet, risultati) {
        const produzioni = [];
        
        // Zone tipiche del rapportino
        const zoneRapportino = [
            { nome: 'Personale', rows: [10, 25], cols: [1, 3] },
            { nome: 'Mezzi', rows: [10, 25], cols: [9, 13] },
            { nome: 'Forniture', rows: [25, 40], cols: [0, 3] }
        ];
        
        zoneRapportino.forEach(zona => {
            for (let row = zona.rows[0]; row <= zona.rows[1]; row++) {
                const descrizione = this.getCellValue(sheet, XLSX.utils.encode_cell({r: row, c: zona.cols[0]}));
                const quantita = parseFloat(this.getCellValue(sheet, XLSX.utils.encode_cell({r: row, c: zona.cols[1]})));
                
                if (descrizione && quantita && quantita > 0) {
                    // Trova il codice ODL corrispondente
                    const codiceODL = this.trovaCodiceDaDescrizione(descrizione, zona.nome);
                    
                    if (codiceODL) {
                        const operatore = this.trovaOperatoreVicino(sheet, row, zona.cols[0]);
                        const attivita = this.trovaAttivitaVicina(sheet, row, risultati.attivita);
                        
                        produzioni.push({
                            data: risultati.dataLavoro,
                            codice: codiceODL,
                            quantita: quantita,
                            operatore: operatore || 'Operatore generico',
                            attivita: attivita || 'Attività varie',
                            zona: zona.nome,
                            categoria: this.determinaCategoriaFromZona(zona.nome)
                        });
                    }
                }
            }
        });
        
        return produzioni;
    },
    
    // 🧠 TROVA OPERATORE VICINO
    trovaOperatoreVicino(sheet, targetRow, targetCol) {
        // Cerca nell'intorno della cella
        for (let rowOffset = -2; rowOffset <= 2; rowOffset++) {
            for (let colOffset = -2; colOffset <= 2; colOffset++) {
                const cellRef = XLSX.utils.encode_cell({r: targetRow + rowOffset, c: targetCol + colOffset});
                const cellValue = this.getCellValue(sheet, cellRef);
                
                if (cellValue && this.sembraNomeOperatore(cellValue)) {
                    return cellValue.trim();
                }
            }
        }
        return null;
    },
    
    // 🧠 TROVA ATTIVITÀ VICINA
    trovaAttivitaVicina(sheet, targetRow, mappaAttivita) {
        // Cerca l'attività più vicina
        let attivitaVicina = null;
        let distanzaMinima = Infinity;
        
        mappaAttivita.forEach((attivita, key) => {
            const [row, col] = key.split('_').map(Number);
            const distanza = Math.abs(row - targetRow);
            
            if (distanza < distanzaMinima) {
                distanzaMinima = distanza;
                attivitaVicina = attivita;
            }
        });
        
        return attivitaVicina;
    },
    
    // 🧠 TROVA CODICE DA DESCRIZIONE
    trovaCodiceDaDescrizione(descrizione, zona) {
        const desc = descrizione.toLowerCase();
        
        // Mapping intelligente per zona
        const mappingZone = {
            'Personale': {
                'capo': 'P12002630',
                'operaio': 'P120026314',
                'tecnico': 'P12002630'
            },
            'Mezzi': {
                'piattaforma': 'P120028254',
                'aspiratore': 'P120028686',
                'muletto': 'P120028688',
                'telescopico': 'P120029262'
            },
            'Forniture': {
                'ldpe': 'P120027834',
                'cartello': 'P120029110',
                'nastro': 'P120029288',
                'filtro': 'P120029293'
            }
        };
        
        const mappings = mappingZone[zona] || {};
        
        for (const [keyword, codice] of Object.entries(mappings)) {
            if (desc.includes(keyword)) {
                return codice;
            }
        }
        
        // Fallback: cerca negli item esistenti
        const itemTrovato = this.state.itemsData.find(item => 
            item.descrizione.toLowerCase().includes(desc.substring(0, 10))
        );
        
        return itemTrovato?.codiceMateriale || null;
    },
    
    // 🧠 DETERMINA CATEGORIA DA ZONA
    determinaCategoriaFromZona(zona) {
        const mappingCategorie = {
            'Personale': 'manodopera',
            'Mezzi': 'noleggi',
            'Forniture': 'materiali'
        };
        return mappingCategorie[zona] || 'servizi';
    },
    
    // 🧠 MOSTRA RISULTATI ESTRAZIONE
    mostraRisultatiEstrazione(risultati) {
        let html = `
            <div class="alert alert-success">
                <strong>🧠 ESTRAZIONE AUTOMATICA COMPLETATA</strong><br>
                📊 ${risultati.statistiche.celleAnalizzate} celle analizzate<br>
                👥 ${risultati.operatori.size} operatori trovati<br>
                📋 ${risultati.statistiche.attivitaTrovate} attività riconosciute<br>
                🔧 ${risultati.statistiche.produzioniCreate} produzioni create<br>
                📅 Data lavoro: ${new Date(risultati.dataLavoro).toLocaleDateString('it-IT')}
            </div>
        `;
        
        // Mostra operatori trovati
        if (risultati.operatori.size > 0) {
            html += `
                <div class="panel mt-2">
                    <h4>👥 OPERATORI RICONOSCIUTI AUTOMATICAMENTE</h4>
                    <div class="grid grid-auto">
                        ${Array.from(risultati.operatori).map(op => 
                            `<div class="badge badge-manodopera">${op}</div>`
                        ).join('')}
                    </div>
                </div>
            `;
        }
        
        // Mostra attività trovate
        if (risultati.attivita.size > 0) {
            html += `
                <div class="panel mt-2">
                    <h4>📋 ATTIVITÀ RICONOSCIUTE AUTOMATICAMENTE</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${Array.from(new Set(risultati.attivita.values())).map(att => 
                            `<div class="badge badge-servizi">${att}</div>`
                        ).join('')}
                    </div>
                </div>
            `;
        }
        
        if (risultati.produzioni.length > 0) {
            html += `
                <button class="btn btn-success mt-2" onclick="app.eseguiImportAutomatico(${JSON.stringify(risultati).replace(/"/g, '&quot;')})">
                    🚀 Importa Tutto (${risultati.produzioni.length} produzioni)
                </button>
            `;
        }
        
        document.getElementById('importResults').innerHTML = html;
        
        // Salva risultati per export
        this.state.operatoriEstratti = risultati.operatori;
        this.state.descrizioniAttivita = risultati.attivita;
    },
    
    // 🧠 ESEGUI IMPORT AUTOMATICO
    eseguiImportAutomatico(risultati) {
        let imported = 0, errors = 0;
        
        risultati.produzioni.forEach(prod => {
            const item = this.state.itemsData.find(i => i.codiceMateriale === prod.codice);
            if (item) {
                const produzione = {
                    data: prod.data,
                    risorsa: prod.operatore,
                    quantita: prod.quantita,
                    unitaMisura: item.unitaMisura,
                    note: `${prod.attivita} - Import automatico v2.9`,
                    tipo: 'economia',
                    attivita: prod.attivita,
                    operatore: prod.operatore
                };
                
                if (this.addProduction(item, produzione)) {
                    imported++;
                } else {
                    errors++;
                }
            } else {
                errors++;
            }
        });
        
        this.saveToStorage();
        this.updateView();
        this.hideModal();
        this.toast(`✅ Import automatico completato!\n🟢 ${imported} importati\n❌ ${errors} errori`);
    },
        
    // (Removed invalid block that caused syntax error)
    
    parseRapportinoNico(worksheet, sheetName) {
        const produzioni = [];
        const data = this.getCellValue(worksheet, 'G4');
        const dataFormattata = this.parseDate(data);
        
        if (!dataFormattata) {
            return { produzioni: [], errori: [`Data non valida: ${data}`], info: { sheetName } };
        }
        
        // Personale B11:C22
        for (let r = 11; r <= 22; r++) {
            const nome = this.getCellValue(worksheet, `B${r}`);
            const ore = parseFloat(this.getCellValue(worksheet, `C${r}`));
            
            if (nome && ore) {
                const codice = this.findMatchingCode(nome, 'manodopera', r === 11);
                produzioni.push({
                    data: dataFormattata,
                    codice: codice || `PERSON_${r}`,
                    quantita: ore,
                    risorsa: nome,
                    note: `${r === 11 ? 'Capo Cantiere' : 'Operaio'} - Auto Import NICO`,
                    categoria: 'manodopera',
                    tipo: 'personale'
                });
            }
        }
        
        // Mezzi J11:M22
        for (let r = 11; r <= 22; r++) {
            const mezzo = this.getCellValue(worksheet, `J${r}`);
            const quantita = parseFloat(this.getCellValue(worksheet, `M${r}`));
            
            if (mezzo && quantita) {
                const codice = this.findMatchingCode(mezzo, 'noleggi');
                produzioni.push({
                    data: dataFormattata,
                    codice: codice || `MEZZO_${r}`,
                    quantita,
                    risorsa: mezzo,
                    note: 'Mezzo/Attrezzatura - Auto Import NICO',
                    categoria: 'noleggi',
                    tipo: 'mezzo'
                });
            }
        }
        
        // Forniture A26:C35
        for (let r = 26; r <= 35; r++) {
            const fornitura = this.getCellValue(worksheet, `A${r}`);
            const quantita = parseFloat(this.getCellValue(worksheet, `C${r}`));
            
            if (fornitura && quantita) {
                const codice = this.findMatchingCode(fornitura, 'materiali');
                produzioni.push({
                    data: dataFormattata,
                    codice: codice || `FORN_${r}`,
                    quantita,
                    risorsa: 'Fornitura',
                    note: `Materiale: ${fornitura} - Auto Import NICO`,
                    categoria: 'materiali',
                    tipo: 'fornitura'
                });
            }
        }
        
        return { produzioni, errori: [], info: { sheetName, dataLavorata: dataFormattata } };
    },
    
    executeNicoImport(results) {
        let imported = 0, errors = 0;
        
        results.forEach(result => {
            result.produzioni.forEach(prod => {
                const item = this.state.itemsData.find(i => i.codiceMateriale === prod.codice);
                if (item && this.addProduction(item, prod)) {
                    imported++;
                } else {
                    errors++;
                }
            });
        });
        
        this.saveToStorage();
        this.updateView();
        this.hideModal();
        this.toast(`✅ Import completato!\n${imported} importati, ${errors} errori`);
    },
    
    // Manual Mapping
    handleManualMapping(workbook) {
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(sheet, {header: 1});
        this.state.rapportinoData = this.analyzeRapportino(jsonData);
        this.showManualMappingInterface();
    },
    
    analyzeRapportino(rows) {
        const result = { data: null, personale: [], mezzi: [], forniture: [] };
        
        // Estrai data e info header
        rows.slice(0, 15).forEach(row => {
            if (row[4] === 'Rapporto di Lavoro del : ' && row[6]) {
                result.data = this.parseDate(row[6]);
            }
        });
        
        // Personale righe 10-24
        rows.slice(10, 25).forEach(row => {
            if (row[1] && row[2] && !isNaN(row[2])) {
                result.personale.push({ nome: row[1].toString().trim(), ore: parseFloat(row[2]) });
            }
        });
        
        // Mezzi righe 10-24 colonne J-M
        rows.slice(10, 25).forEach(row => {
            if (row[9] && row[12] && !isNaN(row[12])) {
                result.mezzi.push({ tipologia: row[9].toString().trim(), quantita: parseFloat(row[12]) });
            }
        });
        
        // Forniture righe 25-40
        rows.slice(25, 40).forEach(row => {
            if (row[0] && row[2] && !isNaN(row[2])) {
                result.forniture.push({ descrizione: row[0].toString().trim(), quantita: parseFloat(row[2]) });
            }
        });
        
        return result;
    },
    
    showManualMappingInterface() {
        const data = this.state.rapportinoData;
        if (!data?.data) {
            document.getElementById('importResults').innerHTML = '<div class="alert alert-danger">❌ Dati non validi</div>';
            return;
        }
        
        let html = `
            <div class="alert alert-info">
                <strong>🎮 MAPPING MANUALE</strong><br>
                📅 Data: ${data.data}<br>
                👥 ${data.personale.length} operai | 🚜 ${data.mezzi.length} mezzi | 📦 ${data.forniture.length} forniture
            </div>
        `;
        
        // Genera mapping per ogni categoria
        ['personale', 'mezzi', 'forniture'].forEach(tipo => {
            if (data[tipo].length > 0) {
                html += `<div class="panel mt-2"><h4>${this.config.categories[tipo === 'personale' ? 'manodopera' : tipo === 'mezzi' ? 'noleggi' : 'materiali'].emoji} ${tipo.toUpperCase()}</h4>`;
                
                data[tipo].forEach((item, idx) => {
                    const id = `${tipo}_${idx}`;
                    html += `
                        <div class="mapping-item included" id="map_${id}">
                            <input type="checkbox" checked onchange="app.updateMappingStyle('${id}')">
                            <div style="flex: 1; margin: 0 10px;">
                                <strong>${item.nome || item.tipologia || item.descrizione}</strong> - 
                                ${item.ore || item.quantita} ${item.ore ? 'ore' : 'unità'}
                            </div>
                            <select class="form-control" style="width: 200px;" id="sel_${id}" onchange="app.updateMappingStyle('${id}')">
                                ${this.getItemOptions(tipo === 'personale' ? 'manodopera' : tipo === 'mezzi' ? 'noleggi' : 'materiali')}
                            </select>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
        });
        
        html += `
            <button class="btn btn-success mt-2" onclick="app.executeManualImport()">
                💾 Esegui Import
            </button>
        `;
        
        document.getElementById('importResults').innerHTML = html;
    },
    
    // 🎯 FIX DROPDOWN FORNITURE - Includi SERVIZI nella mappatura
    getItemOptions(categoria) {
        let items;
        let opts = '<option value="">-- Lavoro a Misura --</option>';
        
        // ✅ Operai - Solo manodopera (RIMANE UGUALE)
        if (categoria === 'manodopera') {
            items = this.state.itemsData.filter(i => i.categoria === 'manodopera');
            items.forEach(item => {
                opts += `<option value="${item.codiceMateriale}">${item.codiceMateriale} - ${item.descrizione.substring(0, 40)}...</option>`;
            });
        }
        // ✅ Mezzi - Solo noleggi (RIMANE UGUALE)  
        else if (categoria === 'noleggi') {
            items = this.state.itemsData.filter(i => i.categoria === 'noleggi');
            items.forEach(item => {
                opts += `<option value="${item.codiceMateriale}">${item.codiceMateriale} - ${item.descrizione.substring(0, 40)}...</option>`;
            });
        }
        // ✅ Forniture - Materiali + Servizi + Tutto il resto (FIX PRINCIPALE)
        else if (categoria === 'materiali') {
            // Filtra TUTTO tranne manodopera e noleggi
            const fornitureItems = this.state.itemsData.filter(item => 
                item.categoria !== 'manodopera' && 
                item.categoria !== 'noleggi'
            );
            
            // Prima i materiali
            const materiali = fornitureItems.filter(item => item.categoria === 'materiali');
            if (materiali.length > 0) {
                opts += '<optgroup label="📦 MATERIALI">';
                materiali.forEach(item => {
                    opts += `<option value="${item.codiceMateriale}">${item.codiceMateriale} - ${item.descrizione.substring(0, 40)}...</option>`;
                });
                opts += '</optgroup>';
            }
            
            // Poi i servizi (QUESTO ERA IL PROBLEMA!)
            const servizi = fornitureItems.filter(item => item.categoria === 'servizi');
            if (servizi.length > 0) {
                opts += '<optgroup label="🔧 SERVIZI">';
                servizi.forEach(item => {
                    opts += `<option value="${item.codiceMateriale}">${item.codiceMateriale} - ${item.descrizione.substring(0, 40)}...</option>`;
                });
                opts += '</optgroup>';
            }
            
            // Infine tutto il resto (categorie non standard)
            const altre = fornitureItems.filter(item => 
                item.categoria !== 'materiali' && 
                item.categoria !== 'servizi'
            );
            if (altre.length > 0) {
                opts += '<optgroup label="📋 ALTRE CATEGORIE">';
                altre.forEach(item => {
                    opts += `<option value="${item.codiceMateriale}">${item.codiceMateriale} - ${item.descrizione.substring(0, 40)}...</option>`;
                });
                opts += '</optgroup>';
            }
        }
        // Fallback per altre categorie
        else {
            items = this.state.itemsData.filter(i => i.categoria === categoria);
            items.forEach(item => {
                opts += `<option value="${item.codiceMateriale}">${item.codiceMateriale} - ${item.descrizione.substring(0, 40)}...</option>`;
            });
        }
        
        return opts;
    },
    
    updateMappingStyle(id) {
        const container = document.getElementById(`map_${id}`);
        const checkbox = container.querySelector('input[type="checkbox"]');
        const select = document.getElementById(`sel_${id}`);
        
        container.className = 'mapping-item';
        if (!checkbox.checked) {
            container.classList.add('excluded');
        } else if (!select.value) {
            container.classList.add('misura');
        } else {
            container.classList.add('included');
        }
    },
    
    executeManualImport() {
        const data = this.state.rapportinoData;
        let economia = 0, misura = 0;
        const lavoriMisura = [];
        
        ['personale', 'mezzi', 'forniture'].forEach(tipo => {
            data[tipo].forEach((item, idx) => {
                const id = `${tipo}_${idx}`;
                const checkbox = document.querySelector(`#map_${id} input[type="checkbox"]`);
                const select = document.getElementById(`sel_${id}`);
                
                if (checkbox?.checked) {
                    if (select?.value) {
                        const odlItem = this.state.itemsData.find(i => i.codiceMateriale === select.value);
                        if (odlItem) {
                            this.addProduction(odlItem, {
                                data: data.data,
                                risorsa: item.nome || item.tipologia || item.descrizione,
                                quantita: item.ore || item.quantita,
                                note: `Import manuale ECONOMIA`,
                                tipo: 'economia'
                            });
                            economia++;
                        }
                    } else {
                        lavoriMisura.push({
                            data: data.data,
                            tipo,
                            nome: item.nome || item.tipologia || item.descrizione,
                            quantita: item.ore || item.quantita,
                            unitaMisura: item.ore ? 'ore' : 'unità',
                            note: 'Lavoro a MISURA'
                        });
                        misura++;
                    }
                }
            });
        });
        
        // Salva lavori a misura
        if (lavoriMisura.length > 0) {
            const esistenti = this.getStorageJson(`lavoriMisura_${this.state.currentOdlId}`);
            esistenti.push(...lavoriMisura);
            localStorage.setItem(`lavoriMisura_${this.state.currentOdlId}`, JSON.stringify(esistenti));
        }
        
        this.saveToStorage();
        this.updateView();
        this.hideModal();
        this.toast(`✅ Import completato!\n🟢 Economia: ${economia}\n🟠 Misura: ${misura}`);
    },
    
    // 🎫 EXPORT MENSILE POTENZIATO v2.9
    openExportMensileModal() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        this.showModal('export', `
            <h2>🎫 Export TICKET Sistema v2.9 POTENZIATO</h2>
            <div class="alert alert-info">
                <strong>🎯 TICKET POTENZIATO v2.9</strong><br>
                • <strong>TUTTE LE COLONNE ODL:</strong> Include anche item senza produzione<br>
                • <strong>OPERATORI SEPARATI:</strong> Colonne multiple automatiche<br>
                • <strong>DESCRIZIONI ATTIVITÀ:</strong> Mappate nella riga del giorno lavorato<br>
                • <strong>EXPORT UNIFICATO:</strong> Un singolo file Excel chiamato "Ticket"
            </div>
            <div class="panel">
                <h3 style="color: var(--gold);">📅 Seleziona Periodo</h3>
                <div class="grid grid-auto">
                    <div>
                        <label>📅 Data Inizio:</label>
                        <input type="date" id="exportDateFrom" class="form-control" value="${firstDay.toISOString().split('T')[0]}">
                    </div>
                    <div>
                        <label>📅 Data Fine:</label>
                        <input type="date" id="exportDateTo" class="form-control" value="${lastDay.toISOString().split('T')[0]}">
                    </div>
                </div>
                <button class="btn btn-info mt-2" onclick="app.analizzaPeriodoPotenziato()" style="width: 100%;">
                    🔍 Analizza Periodo v2.9
                </button>
            </div>
            <div id="exportResults"></div>
        `);
    },
    
    // 🔍 ANALIZZA PERIODO POTENZIATO v2.9
    analizzaPeriodoPotenziato() {
        const dataInizio = new Date(document.getElementById('exportDateFrom').value);
        const dataFine = new Date(document.getElementById('exportDateTo').value);
        
        if (!dataInizio || !dataFine) {
            alert('⚠️ Seleziona entrambe le date!');
            return;
        }
        
        console.log('🔍 Analisi periodo:', dataInizio, 'to', dataFine);
        
        // Analizza tutti gli item ODL per il periodo
        const analisi = this.analizzaItemsCompleta(dataInizio, dataFine);
        this.mostraAnalisiPotenziata(analisi);
    },
    
    // 📊 ANALIZZA ITEMS COMPLETA (TUTTI GLI ITEM ODL)
    analizzaItemsCompleta(dataInizio, dataFine) {
        const analisi = {
            periodo: { inizio: dataInizio, fine: dataFine },
            itemsAnalizzati: this.state.itemsData.length,
            produzioniTrovate: 0,
            operatoriUnici: new Set(),
            dateUniche: new Set(),
            productions: []
        };
        
        // Analizza ogni item ODL
        this.state.itemsData.forEach(item => {
            const produzioniPeriodo = (item.produzione || []).filter(prod => {
                const dataProd = new Date(prod.data);
                return dataProd >= dataInizio && dataProd <= dataFine;
            });
            
            // Aggiungi item anche se non ha produzioni (per TICKET completo)
            if (produzioniPeriodo.length === 0) {
                // Item senza produzione nel periodo
                analisi.productions.push({
                    data: dataInizio.toISOString().split('T')[0],
                    itemCode: item.codiceMateriale,
                    descrizione: item.descrizione,
                    categoria: item.categoria,
                    quantita: 0,
                    unitaMisura: item.unitaMisura,
                    prezzoUnitario: item.prezzoUnitario,
                    risorsa: 'N/A',
                    note: 'Item ODL senza produzione',
                    tipo: 'economia'
                });
            } else {
                // Item con produzioni
                produzioniPeriodo.forEach(prod => {
                    analisi.productions.push({
                        data: prod.data,
                        itemCode: item.codiceMateriale,
                        descrizione: prod.note || item.descrizione,
                        categoria: item.categoria,
                        quantita: prod.quantita,
                        unitaMisura: item.unitaMisura,
                        prezzoUnitario: item.prezzoUnitario,
                        risorsa: prod.risorsa,
                        note: prod.note || '',
                        tipo: prod.tipo || 'economia'
                    });
                    
                    analisi.operatoriUnici.add(prod.risorsa);
                    analisi.dateUniche.add(prod.data);
                    analisi.produzioniTrovate++;
                });
            }
        });
        
        console.log('📊 Analisi completata:', analisi);
        return analisi;
    },
    
    // 📋 MOSTRA ANALISI POTENZIATA
    mostraAnalisiPotenziata(analisi) {
        console.log('📋 Mostra analisi:', analisi);
        
        const totalePeriodo = analisi.productions.reduce((sum, p) => sum + (p.quantita * p.prezzoUnitario), 0);
        
        document.getElementById('exportResults').innerHTML = `
            <div class="alert alert-success">
                <h3>📊 ANALISI PERIODO COMPLETATA v2.9</h3>
                <div class="grid grid-auto">
                    <div><strong>📋 Item ODL totali:</strong> ${analisi.itemsAnalizzati}</div>
                    <div><strong>📦 Record da esportare:</strong> ${analisi.productions.length}</div>
                    <div><strong>👥 Operatori trovati:</strong> ${analisi.operatoriUnici.size}</div>
                    <div><strong>📅 Giorni lavorativi:</strong> ${analisi.dateUniche.size}</div>
                    <div><strong>💰 Totale periodo:</strong> €${totalePeriodo.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                </div>
            </div>
            <div class="grid grid-auto mt-2">
                <button class="btn btn-success" onclick="app.generaTICKETPotenziato()" style="width: 100%;">
                    🎫 GENERA TICKET EXCEL v2.9
                </button>
                <button class="btn btn-info" onclick="app.hideModal()" style="width: 100%;">
                    ❌ Chiudi
                </button>
            </div>
        `;
        
        // Salva per export
        this.state.exportMensileData = analisi;
    },
    
    // 🎫 GENERA TICKET POTENZIATO v2.9
    generaTICKETPotenziato() {
        if (!this.state.exportMensileData) {
            alert('⚠️ Esegui prima l\'analisi del periodo!');
            return;
        }
        
        console.log('🎫 Genera TICKET:', this.state.exportMensileData);
        
        const ticketData = this.costruisciTICKETCompleto(this.state.exportMensileData);
        const workbook = this.creaTICKETExcel(ticketData);
        
        // Nome file con info ODL
        const odlInfo = this.getStorageJson('odlsList')[this.state.currentOdlId];
        const periodo = this.state.exportMensileData.periodo;
        const nomeFile = `TICKET_${odlInfo?.name || 'ODL'}_${periodo.inizio.toISOString().split('T')[0]}_${periodo.fine.toISOString().split('T')[0]}.xlsx`;
        
        XLSX.writeFile(workbook, nomeFile);
        
        this.toast(`🎫 TICKET GENERATO v2.9!\n\n📁 ${nomeFile}\n📊 ${ticketData.righe.length} righe di dati\n🎯 ${ticketData.colonne.length} colonne ODL\n\n✅ Pronto per fatturazione!`);
        this.hideModal();
    },
    
    // 🏗️ COSTRUISCI TICKET COMPLETO
    costruisciTICKETCompleto(analisi) {
        console.log('🏗️ Costruisci TICKET completo:', analisi);
        
        // Raggruppa dati per costruire la matrice
        const itemsUnici = [...new Set(analisi.productions.map(p => p.itemCode))];
        const dateUniche = [...new Set(analisi.productions.map(p => p.data))].sort();
        const operatoriUnici = [...analisi.operatoriUnici].sort();
        
        // Trova item ODL per info aggiuntive
        const itemsInfo = new Map();
        this.state.itemsData.forEach(item => {
            itemsInfo.set(item.codiceMateriale, item);
        });
        
        // Costruisci header colonne
        const colonne = ['Data', 'Descrizione Attività'];
        itemsUnici.forEach(codice => {
            const item = itemsInfo.get(codice);
            colonne.push(`${codice}${item ? ` (${item.unitaMisura})` : ''}`);
        });
        
        // Costruisci righe dati
        const righe = [];
        
        // Riga descrizioni item
        const rigaDescrizioni = ['', 'DESCRIZIONI ITEM'];
        itemsUnici.forEach(codice => {
            const item = itemsInfo.get(codice);
            rigaDescrizioni.push(item ? this.estraiNomeBreveColonna(item.descrizione) : codice);
        });
        righe.push(rigaDescrizioni);
        
        // Riga totali periodo
        const rigaTotali = ['', 'TOTALI PERIODO'];
        itemsUnici.forEach(codice => {
            const totale = analisi.productions
                .filter(p => p.itemCode === codice)
                .reduce((sum, p) => sum + p.quantita, 0);
            rigaTotali.push(totale > 0 ? totale : '');
        });
        righe.push(rigaTotali);
        
        // Righe giornaliere
        dateUniche.forEach(data => {
            const recordsGiorno = analisi.productions.filter(p => p.data === data);
            
            if (recordsGiorno.length > 0) {
                // Raggruppa per descrizione attività
                const attivitaGiorno = this.getDescrizioniGiorno(data, recordsGiorno);
                
                attivitaGiorno.forEach(descrizione => {
                    const rigaGiorno = [data, descrizione];
                    
                    itemsUnici.forEach(codice => {
                        const quantita = this.getQuantitaGiornoItem(recordsGiorno, codice, descrizione);
                        rigaGiorno.push(quantita > 0 ? quantita : '');
                    });
                    
                    righe.push(rigaGiorno);
                });
            }
        });
        
        console.log('🏗️ TICKET costruito:', { colonne: colonne.length, righe: righe.length });
        
        return { colonne, righe, analisi };
    },
    
    // 📋 GET DESCRIZIONI GIORNO
    getDescrizioniGiorno(data, recordsGiorno) {
        const descrizioni = new Set();
        recordsGiorno.forEach(record => {
            const desc = record.note || record.descrizione || 'Attività varie';
            descrizioni.add(desc.substring(0, 100)); // Limite lunghezza
        });
        return Array.from(descrizioni);
    },
    
    // 📊 GET QUANTITÀ GIORNO ITEM
    getQuantitaGiornoItem(recordsGiorno, codiceItem, descrizione) {
        return recordsGiorno
            .filter(r => r.itemCode === codiceItem && 
                         (r.note === descrizione || r.descrizione === descrizione))
            .reduce((sum, r) => sum + r.quantita, 0);
    },
    
    // 📊 CREA TICKET EXCEL
    creaTICKETExcel(ticketData) {
        console.log('📊 Crea TICKET Excel:', ticketData);
        
        const workbook = XLSX.utils.book_new();
        
        // Costruisci dati foglio
        const worksheetData = [ticketData.colonne, ...ticketData.righe];
        
        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
        
        // Imposta larghezza colonne
        const colWidths = ticketData.colonne.map((col, idx) => {
            if (idx === 0) return { wch: 12 }; // Data
            if (idx === 1) return { wch: 30 }; // Descrizione
            return { wch: 15 }; // Item codes
        });
        worksheet['!cols'] = colWidths;
        
        XLSX.utils.book_append_sheet(workbook, worksheet, 'TICKET');
        
        console.log('📊 Excel creato con successo');
        return workbook;
    },
    
    // Utility functions
    getCellValue(worksheet, address) {
        const cell = worksheet[address];
        return cell ? (cell.v !== undefined ? cell.v : cell.w) : null;
    },
    
    parseDate(input) {
        if (!input) return null;
        
        if (input instanceof Date) return input.toISOString().split('T')[0];
        if (typeof input === 'number') {
            const date = new Date((input - 25569) * 86400 * 1000);
            return date.toISOString().split('T')[0];
        }
        if (typeof input === 'string') {
            const date = new Date(input);
            return isNaN(date) ? null : date.toISOString().split('T')[0];
        }
        return null;
    },
    
    estraiNomeBreveColonna(descrizione) {
        if (!descrizione) return 'N/D';
        
        // Estrai parole chiave per i nomi colonne
        const keywords = {
            'CAPO': 'Capo',
            'OPERAIO': 'Operaio',
            'PIATTAFORMA': 'Piattaf.',
            'ASPIRATORE': 'Aspir.',
            'MULETTO': 'Muletto',
            'FILTRO': 'Filtro',
            'CARTELLO': 'Cartello',
            'NASTRO': 'Nastro'
        };
        
        const desc = descrizione.toUpperCase();
        for (const [keyword, shortName] of Object.entries(keywords)) {
            if (desc.includes(keyword)) return shortName;
        }
        
        // Fallback: prime 3 parole o 20 caratteri
        const words = descrizione.split(' ');
        if (words.length > 3) {
            return words.slice(0, 3).join(' ');
        }
        return descrizione.length > 20 ? descrizione.substring(0, 20) + '...' : descrizione;
    },
    
    // Toast notifications
    toast(message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            background: var(--success); color: white; padding: 15px 25px;
            border-radius: 8px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease; max-width: 400px; white-space: pre-line;
        `;
        toast.innerHTML = `<span style="margin-right: 10px;">🐾</span>${message}`;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 4000);
    },
    
    // 🎯 UI & Dashboard Management
    updateView() {
        this.updateOdlInfo();
        if (this.state.itemsData.length > 0) {
            this.showDataPanels();
            this.updateTotals();
            this.renderGauges();
        } else {
            this.hideDataPanels();
        }
    },
    
    updateOdlInfo() {
        const info = document.getElementById('currentOdlInfo');
        const buttons = ['btnImportRapportino', 'btnSaveOdl', 'btnBackup', 'btnExportMensile', 'btnLavoriMisura', 'btnResetData'];
        
        if (this.state.currentOdlId) {
            const odl = this.getStorageJson('odlsList')[this.state.currentOdlId];
            info.innerHTML = `📋 <strong>${odl?.name}</strong><br><small>Creato: ${odl?.date}</small>`;
            buttons.forEach(id => document.getElementById(id)?.classList.remove('hidden'));
        } else {
            info.textContent = 'Nessun ODL caricato';
            buttons.forEach(id => document.getElementById(id)?.classList.add('hidden'));
        }
    },
    
    showDataPanels() {
        document.getElementById('totalsPanel')?.classList.remove('hidden');
        document.getElementById('filtersPanel')?.classList.remove('hidden');
    },
    
    hideDataPanels() {
        document.getElementById('totalsPanel')?.classList.add('hidden');
        document.getElementById('filtersPanel')?.classList.add('hidden');
        const gaugesContainer = document.getElementById('gaugesContainer');
        if (gaugesContainer) gaugesContainer.innerHTML = '';
    },
    
    updateTotals() {
        const items = this.state.itemsData;
        const totalBudget = items.reduce((sum, i) => sum + i.prezzoTotale, 0);
        const totalConsumed = items.reduce((sum, i) => sum + (i.consumato || 0), 0);
        const completed = items.filter(i => i.completamento >= 99.9).length;
        
        const totalItems = document.getElementById('totalItems');
        const totalConsumedEl = document.getElementById('totalConsumed');
        const totalRemaining = document.getElementById('totalRemaining');
        const completedItems = document.getElementById('completedItems');
        
        if (totalItems) totalItems.textContent = items.length;
        if (totalConsumedEl) totalConsumedEl.textContent = '€ ' + totalConsumed.toLocaleString('it-IT', {minimumFractionDigits: 2});
        if (totalRemaining) totalRemaining.textContent = '€ ' + (totalBudget - totalConsumed).toLocaleString('it-IT', {minimumFractionDigits: 2});
        if (completedItems) completedItems.textContent = completed;
    },
    
    renderGauges() {
        const container = document.getElementById('gaugesContainer');
        if (!container) return;
        
        const items = this.state.currentFilter === 'all' ? 
            this.state.itemsData : 
            this.state.itemsData.filter(i => i.categoria === this.state.currentFilter);
        
        container.innerHTML = items.map(item => this.createProgressCardHTML(item)).join('');
    },
    
    createProgressCardHTML(item) {
        const perc = item.completamento || 0;
        const color = perc >= 90 ? 'var(--success)' : perc >= 70 ? 'var(--warning)' : perc >= 40 ? '#e67e22' : 'var(--danger)';
        
        return `
            <div class="progress-card" onclick="app.openProgressModal(${item.id})">
                <div class="card-header">
                    <strong>${item.codiceMateriale}</strong>
                    <span class="badge badge-${item.categoria}">${this.config.categories[item.categoria].emoji}</span>
                </div>
                <div class="progress-info">
                    <div class="progress-text">${Math.round(perc)}%</div>
                    <div class="progress-bar" style="background: conic-gradient(${color} ${perc * 3.6}deg, rgba(255,255,255,0.1) 0deg);"></div>
                </div>
                <div class="card-footer">
                    <small>${item.descrizione.substring(0, 30)}...</small>
                </div>
            </div>
        `;
    },
    
    // 🔧 Production Management
    addProduction(item, prod) {
        if (!item.produzione) item.produzione = [];
        
        if (prod.tipo === 'economia') {
            const totEcon = item.produzione
                .filter(p => p.tipo !== 'misura')
                .reduce((sum, p) => sum + p.quantita, 0);
            const available = Math.max(0, item.quantita - totEcon);
            
            if (prod.quantita > available) {
                console.warn(`🚫 Limite superato per ${item.codiceMateriale}! Max: ${available} ${item.unitaMisura}`);
                return false;
            }
        }
        
        item.produzione.push(prod);
        this.updateItemProgress(item);
        return true;
    },
    
    updateItemProgress(item) {
        const prodEcon = (item.produzione || [])
            .filter(p => p.tipo !== 'misura')
            .reduce((sum, p) => sum + p.quantita, 0);
        
        item.completamento = item.quantita ? Math.min(100, (prodEcon / item.quantita) * 100) : 0;
        item.consumato = item.quantita ? Math.min(item.prezzoTotale, (prodEcon / item.quantita) * item.prezzoTotale) : 0;
    },
    
    openProgressModal(itemId) {
        const item = this.state.itemsData[itemId];
        if (!item) return;
        
        const prod = item.produzione || [];
        const prodTot = prod.reduce((sum, p) => sum + p.quantita, 0);
        
        let prodTable = '<div class="table-container"><table><tr><th>Data</th><th>Risorsa</th><th>Q.tà</th><th>Note</th><th></th></tr>';
        if (prod.length === 0) {
            prodTable += '<tr><td colspan="5" style="text-align:center;">Nessuna produzione</td></tr>';
        } else {
            prod.forEach((p, idx) => {
                prodTable += `
                    <tr>
                        <td>${p.data}</td>
                        <td>${p.risorsa}</td>
                        <td>${p.quantita} ${p.unitaMisura}</td>
                        <td>${p.note || ''}</td>
                        <td><button onclick="app.deleteProduzione(${itemId}, ${idx})" class="btn-small btn-danger">🗑️</button></td>
                    </tr>
                `;
            });
        }
        prodTable += '</table></div>';
        
        this.showModal('progress', `
            <h2>${item.codiceMateriale}</h2>
            <p style="opacity: 0.8;">${item.descrizione}</p>
            
            <div class="panel">
                <strong>Budget:</strong> €${item.prezzoTotale.toLocaleString('it-IT')} | 
                <strong>Previsto:</strong> ${item.quantita} ${item.unitaMisura} | 
                <strong>Prodotto:</strong> ${prodTot} ${item.unitaMisura}
            </div>
            
            ${prodTable}
            
            <form onsubmit="app.addProduzioneManuale(event, ${itemId})" class="mt-2">
                <div class="grid grid-auto">
                    <input type="date" id="prod_data" class="form-control" value="${new Date().toISOString().split('T')[0]}" required>
                    <input type="text" id="prod_risorsa" class="form-control" placeholder="Operatore/Risorsa" required>
                    <input type="number" id="prod_quantita" class="form-control" placeholder="Quantità" step="0.01" required>
                </div>
                <input type="text" class="form-control" id="prod_note" placeholder="Note attività">
                <button type="submit" class="btn btn-success" style="width: 100%;">+ Aggiungi Produzione</button>
            </form>
        `);
    },
    
    addProduzioneManuale(e, itemId) {
        e.preventDefault();
        const item = this.state.itemsData[itemId];
        
        const produzione = {
            data: document.getElementById('prod_data').value,
            risorsa: document.getElementById('prod_risorsa').value,
            quantita: parseFloat(document.getElementById('prod_quantita').value),
            unitaMisura: item.unitaMisura,
            note: document.getElementById('prod_note').value,
            tipo: 'economia'
        };
        
        if (this.addProduction(item, produzione)) {
            this.saveToStorage();
            this.updateView();
            this.openProgressModal(itemId);
            this.toast(`✅ Produzione aggiunta!`);
        } else {
            alert('❌ Errore: quantità superiore al disponibile!');
        }
    },
    
    deleteProduzione(itemId, idx) {
        if (!confirm('🗑️ Cancellare questa produzione?')) return;
        
        const item = this.state.itemsData[itemId];
        item.produzione.splice(idx, 1);
        this.updateItemProgress(item);
        this.saveToStorage();
        this.updateView();
        this.openProgressModal(itemId);
        this.toast('🗑️ Produzione eliminata');
    },
    
    // 🎛️ Utility functions
    setFilter(filter) {
        document.querySelectorAll('[data-filter]').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-filter="${filter}"]`)?.classList.add('active');
        this.state.currentFilter = filter;
        this.renderGauges();
    },
    
    resetView() {
        this.state.currentOdlId = null;
        this.state.itemsData = [];
        this.updateView();
    },
    
    resetCurrentODL() {
        if (!confirm('🗑️ Cancellare TUTTI i dati di produzione?')) return;
        
        this.state.itemsData.forEach(item => {
            item.produzione = [];
            item.completamento = 0;
            item.consumato = 0;
        });
        
        this.saveToStorage();
        this.updateView();
        this.toast('✅ Reset completato!');
    },
    
    salvaODLManuale() {
        this.saveToStorage();
        this.toast('✅ ODL salvato manualmente!');
    },
    
    // 💾 Storage helpers
    saveToStorage() {
        if (this.state.currentOdlId) {
            localStorage.setItem(`odlData_${this.state.currentOdlId}`, JSON.stringify(this.state.itemsData));
            localStorage.setItem('lastOdlId', this.state.currentOdlId);
        }
    },
    
    loadFromStorage() {
        const lastOdlId = localStorage.getItem('lastOdlId');
        if (lastOdlId) {
            const selector = document.getElementById('odlSelector');
            if (selector) {
                selector.value = lastOdlId;
                this.loadODL(lastOdlId);
            }
        }
    },
    
    getStorageJson(key) {
        try {
            return JSON.parse(localStorage.getItem(key) || '{}');
        } catch (e) {
            console.warn('⚠️ Errore parsing JSON:', key, e);
            return {};
        }
    },
    
    // 🎭 Modal system
    initModals() {
        const container = document.getElementById('modalsContainer');
        if (!container) {
            document.body.insertAdjacentHTML('beforeend', '<div id="modalsContainer"></div>');
        }
        
        const modals = ['progress', 'newOdl', 'import', 'export', 'backup', 'lavori'];
        
        modals.forEach(id => {
            if (!document.getElementById(`${id}Modal`)) {
                document.getElementById('modalsContainer').innerHTML += `
                    <div class="modal" id="${id}Modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <span class="close" onclick="app.hideModal()">&times;</span>
                            </div>
                            <div id="${id}ModalContent"></div>
                        </div>
                    </div>
                `;
            }
        });
    },
    
    showModal(id, content) {
        const modalContent = document.getElementById(`${id}ModalContent`);
        const modal = document.getElementById(`${id}Modal`);
        
        if (modalContent && modal) {
            modalContent.innerHTML = content;
            modal.style.display = 'block';
        }
    },
    
    hideModal() {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    },
};
    
// Auto-save ogni 30 secondi
setInterval(() => {
    if (app.state.currentOdlId && app.state.itemsData.length > 0) {
        app.saveToStorage();
    }
}, 30000);

// Inizializzazione
document.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>